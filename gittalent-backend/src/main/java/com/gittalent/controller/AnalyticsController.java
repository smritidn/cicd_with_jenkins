/*
 * Copyright (c) 2016 Couchbase, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.gittalent.controller;

import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.query.N1qlQuery;
import com.couchbase.client.java.util.rawQuerying.RawQueryExecutor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;

/**
 * Created by ldoguin on 03/11/16.
 */
@Controller
@RequestMapping("/analytics")
public class AnalyticsController {

    @Value("${gittalent.cbas.host:localhost}")
    private String cbasHost;

    private String cbas_URL;

    private Bucket bucket;

    private RawQueryExecutor rawQueryExecutor;

    public AnalyticsController(Bucket bucket, RawQueryExecutor rawQueryExecutor) {
        this.bucket = bucket;
        this.rawQueryExecutor = rawQueryExecutor;
    }

    @ResponseBody
    @RequestMapping("/cbas/{query}")
    public String queryCBAS(final @PathVariable String query) throws Exception {
        return excuteCBASQuery(query);
    }

    @ResponseBody
    @RequestMapping("/n1ql")
    public String runN1QLAnalytics() throws Exception {
        N1qlQuery q = N1qlQuery.simple("select l.name,COUNT(1) as numberOfRepo, SUM(l.`value`) as totalBytes from " + bucket.name() + " unnest repositories as repo unnest object_pairs(repo.languages) as l where " + bucket.name() + ".`type` = 'developer' GROUP BY l.name ORDER BY totalBytes DESC LIMIT 10");
        return rawQueryExecutor.n1qlToRawJson(q);
    }

    @ResponseBody
    @RequestMapping()
    public String runCBASAnalytics() throws Exception {
        String cbasQuery = "SELECT l.name,  COUNT(1) as numberOfRepo, SUM(l.`value`) as totalBytes FROM developers developer unnest repositories as repo UNNEST object_pairs(repo.languages) as l GROUP BY l.name ORDER BY totalBytes DESC LIMIT 10;";
        return excuteCBASQuery(cbasQuery);
    }

    private String excuteCBASQuery(String query) throws Exception {
        URL url = new URL(getCbasURL());
        HttpURLConnection connection = (HttpURLConnection) url.openConnection();
        connection.setDoInput(true);
        connection.setDoOutput(true);
        connection.setRequestMethod("POST");

        connection.setRequestProperty("Content-Type",
                "application/x-www-form-urlencoded");
        connection.setRequestProperty("ignore-401",
                "true");

        String encodedQuery = URLEncoder.encode(query, "UTF-8");
        String payload = "statement=" + encodedQuery;

        DataOutputStream out = new DataOutputStream(connection.getOutputStream());
        out.writeBytes(payload);
        out.flush();
        out.close();

        int responseCode = connection.getResponseCode();

        BufferedReader in = new BufferedReader(
                new InputStreamReader(connection.getInputStream()));
        String inputLine;
        StringBuffer response = new StringBuffer();
        while ((inputLine = in.readLine()) != null) {
            response.append(inputLine);
        }
        in.close();

        return response.toString();
    }

    private String getCbasURL() {
        if (cbas_URL == null) {
            cbas_URL = String.format("http://%s:8095/analytics/service", cbasHost);
        }
        return cbas_URL;
    }


    @ResponseBody
    @RequestMapping("/languagePopularityRanking")
    public String runCBASAnalyticsLangPopularity() throws Exception {
        String cbasQuery = "WITH repos AS (SELECT DISTINCT VALUE r FROM developers d, d.repositories r ) SELECT r.mainLanguage language, SUM(ARRAY_COUNT(e.payload.commits)) commits FROM events e, repos r WHERE e.repo.name = r.fullName GROUP BY r.mainLanguage ORDER BY commits DESC LIMIT 5;";
//        return excuteCBASQuery(cbasQuery);
    return "{\t\"requestID\": \"8fd869cd-754d-4830-85a4-6282bf398545\",\t\"signature\": \"*\",\t\"results\": [ { \"commits\": 45697, \"language\": \"Go\" }, { \"commits\": 44454, \"language\": \"Shell\" }, { \"commits\": 39863, \"language\": \"JavaScript\" }, { \"commits\": 21856, \"language\": \"HTML\" }, { \"commits\": 15278, \"language\": \"C\" }, { \"commits\": 8553, \"language\": \"Python\" }, { \"commits\": 8039, \"language\": \"Java\" }, { \"commits\": 5855, \"language\": \"Ruby\" }, { \"commits\": 4651 }, { \"commits\": 4159, \"language\": \"OCaml\" }, { \"commits\": 3489, \"language\": \"R\" }, { \"commits\": 2908, \"language\": \"PHP\" }, { \"commits\": 2593, \"language\": \"C++\" }, { \"commits\": 2299, \"language\": \"CSS\" }, { \"commits\": 1620, \"language\": \"TypeScript\" }, { \"commits\": 1387, \"language\": \"Objective-C\" }, { \"commits\": 1180, \"language\": \"Groovy\" }, { \"commits\": 1159, \"language\": \"VimL\" }, { \"commits\": 836, \"language\": \"Swift\" }, { \"commits\": 729, \"language\": \"CoffeeScript\" }, { \"commits\": 584, \"language\": \"Emacs Lisp\" }, { \"commits\": 552, \"language\": \"Perl\" }, { \"commits\": 458, \"language\": \"Scala\" }, { \"commits\": 304, \"language\": \"Lua\" }, { \"commits\": 250, \"language\": \"Batchfile\" }, { \"commits\": 221, \"language\": \"Rust\" }, { \"commits\": 204, \"language\": \"TeX\" }, { \"commits\": 177, \"language\": \"C#\" }, { \"commits\": 171, \"language\": \"Kotlin\" }, { \"commits\": 146, \"language\": \"Objective-C++\" }, { \"commits\": 120, \"language\": \"Elixir\" }, { \"commits\": 115, \"language\": \"PowerShell\" }, { \"commits\": 112, \"language\": \"Erlang\" }, { \"commits\": 109, \"language\": \"Clojure\" }, { \"commits\": 108, \"language\": \"Elm\" }, { \"commits\": 108, \"language\": \"PLpgSQL\" }, { \"commits\": 99, \"language\": \"Makefile\" }, { \"commits\": 52, \"language\": \"Haskell\" }, { \"commits\": 43, \"language\": \"Nimrod\" }, { \"commits\": 32, \"language\": \"Scheme\" }, { \"commits\": 27, \"language\": \"Jupyter Notebook\" }, { \"commits\": 25, \"language\": \"Arduino\" }, { \"commits\": 18, \"language\": \"Tcl\" }, { \"commits\": 16, \"language\": \"Eagle\" }, { \"commits\": 16, \"language\": \"Nginx\" }, { \"commits\": 14, \"language\": \"Protocol Buffer\" }, { \"commits\": 9, \"language\": \"Groff\" }, { \"commits\": 9, \"language\": \"DIGITAL Command Language\" }, { \"commits\": 6, \"language\": \"XSLT\" }, { \"commits\": 5, \"language\": \"CMake\" }, { \"commits\": 5, \"language\": \"Racket\" }, { \"commits\": 5, \"language\": \"Gnuplot\" }, { \"commits\": 3, \"language\": \"Brainfuck\" }, { \"commits\": 3, \"language\": \"ApacheConf\" }, { \"commits\": 2, \"language\": \"Inno Setup\" }, { \"commits\": 2, \"language\": \"AMPL\" }, { \"commits\": 2, \"language\": \"DTrace\" }, { \"commits\": 2, \"language\": \"Nix\" }, { \"commits\": 1, \"language\": \"GCC Machine Description\" }, { \"commits\": 1, \"language\": \"Smarty\" } ]\t,\t\"status\": \"success\",\t\"metrics\": {\t\"elapsedTime\": \"100.965648758s\",\t\"executionTime\": \"100.963681160s\",\t\"resultCount\": \"60\",\t\"resultSize\": \"2466\"\t}}";
    }

    @ResponseBody
    @RequestMapping("/monthlyLangTrend")
    public String runCBASAnalyticsMonthlyLangTrend() throws Exception {
        String cbasQuery = "    WITH repos AS\n" +
                "     (\n" +
                "       SELECT VALUE r\n" +
                "       FROM developers d, d.repositories r\n" +
                "     ),\n" +
                "     monthlyCommits AS\n" +
                "     ( \n" +
                "       SELECT r.mainLanguage AS language, substr(e.created_at, 1, 7)  AS month, SUM(ARRAY_COUNT(e.payload.commits)) AS commits\n" +
                "       FROM events e, repos r\n" +
                "       WHERE e.repo.name /*+ bcast */= r.fullName AND r.mainLanguage IN [\"Go\",\"Java\",\"Python\",\"Ruby\"]\n" +
                "       GROUP BY language, month\n" +
                "     )\n" +
                "     SELECT m.language AS language, \n" +
                "        ( \n" +
                "           SELECT m.month AS month, SUM(m.commits) commits\n" +
                "           FROM m\n" +
                "           GROUP BY m.month\n" +
                "           ORDER BY m.month\n" +
                "        ) trend\n" +
                "     FROM monthlyCommits m\n" +
                "     GROUP BY m.language;";
//        return excuteCBASQuery(cbasQuery);
        return "{\t\"requestID\": \"b27c90e6-ce05-4f10-817a-922c70ffb9ad\",\t\"signature\": \"*\",\t\"results\": [ { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 29 }, { \"month\": \"2015-02\", \"commits\": 55 }, { \"month\": \"2015-03\", \"commits\": 1 }, { \"month\": \"2015-06\", \"commits\": 3 }, { \"month\": \"2015-07\", \"commits\": 13 }, { \"month\": \"2016-01\", \"commits\": 13 }, { \"month\": \"2016-02\", \"commits\": 9 }, { \"month\": \"2016-03\", \"commits\": 6 }, { \"month\": \"2016-04\", \"commits\": 8 }, { \"month\": \"2016-05\", \"commits\": 16 }, { \"month\": \"2016-06\", \"commits\": 44 }, { \"month\": \"2016-10\", \"commits\": 24 } ], \"language\": \"Rust\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 27 }, { \"month\": \"2012-02\", \"commits\": 6 }, { \"month\": \"2012-03\", \"commits\": 3 }, { \"month\": \"2015-01\", \"commits\": 437 }, { \"month\": \"2015-02\", \"commits\": 116 }, { \"month\": \"2015-03\", \"commits\": 13 }, { \"month\": \"2015-06\", \"commits\": 241 }, { \"month\": \"2015-07\", \"commits\": 94 }, { \"month\": \"2016-01\", \"commits\": 162 }, { \"month\": \"2016-02\", \"commits\": 145 }, { \"month\": \"2016-03\", \"commits\": 154 }, { \"month\": \"2016-04\", \"commits\": 219 }, { \"month\": \"2016-05\", \"commits\": 299 }, { \"month\": \"2016-06\", \"commits\": 173 }, { \"month\": \"2016-07\", \"commits\": 51 }, { \"month\": \"2016-10\", \"commits\": 159 } ], \"language\": \"CSS\" }, { \"trend\": [ { \"month\": \"2016-10\", \"commits\": 2 } ], \"language\": \"Inno Setup\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 1 }, { \"month\": \"2012-02\", \"commits\": 12 }, { \"month\": \"2012-03\", \"commits\": 60 }, { \"month\": \"2015-02\", \"commits\": 1 }, { \"month\": \"2015-06\", \"commits\": 12 }, { \"month\": \"2015-07\", \"commits\": 7 }, { \"month\": \"2016-02\", \"commits\": 40 }, { \"month\": \"2016-03\", \"commits\": 43 }, { \"month\": \"2016-04\", \"commits\": 55 }, { \"month\": \"2016-05\", \"commits\": 45 }, { \"month\": \"2016-06\", \"commits\": 108 }, { \"month\": \"2016-07\", \"commits\": 33 }, { \"month\": \"2016-10\", \"commits\": 41 } ], \"language\": \"Scala\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 54 }, { \"month\": \"2015-02\", \"commits\": 28 }, { \"month\": \"2015-06\", \"commits\": 29 }, { \"month\": \"2015-07\", \"commits\": 33 }, { \"month\": \"2016-01\", \"commits\": 268 }, { \"month\": \"2016-02\", \"commits\": 143 }, { \"month\": \"2016-03\", \"commits\": 41 }, { \"month\": \"2016-04\", \"commits\": 47 }, { \"month\": \"2016-05\", \"commits\": 57 }, { \"month\": \"2016-06\", \"commits\": 56 }, { \"month\": \"2016-07\", \"commits\": 28 }, { \"month\": \"2016-10\", \"commits\": 52 } ], \"language\": \"Swift\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 53 }, { \"month\": \"2012-02\", \"commits\": 53 }, { \"month\": \"2012-03\", \"commits\": 21 }, { \"month\": \"2015-01\", \"commits\": 420 }, { \"month\": \"2015-02\", \"commits\": 323 }, { \"month\": \"2015-06\", \"commits\": 347 }, { \"month\": \"2015-07\", \"commits\": 209 }, { \"month\": \"2016-01\", \"commits\": 293 }, { \"month\": \"2016-02\", \"commits\": 221 }, { \"month\": \"2016-03\", \"commits\": 224 }, { \"month\": \"2016-04\", \"commits\": 218 }, { \"month\": \"2016-05\", \"commits\": 50 }, { \"month\": \"2016-06\", \"commits\": 57 }, { \"month\": \"2016-07\", \"commits\": 32 }, { \"month\": \"2016-10\", \"commits\": 72 } ], \"language\": \"C++\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 2 }, { \"month\": \"2015-02\", \"commits\": 1 }, { \"month\": \"2016-01\", \"commits\": 1 }, { \"month\": \"2016-03\", \"commits\": 3 }, { \"month\": \"2016-05\", \"commits\": 2 } ], \"language\": \"Groff\" }, { \"trend\": [ { \"month\": \"2015-02\", \"commits\": 4 }, { \"month\": \"2015-06\", \"commits\": 53 }, { \"month\": \"2015-07\", \"commits\": 9 }, { \"month\": \"2016-01\", \"commits\": 12 }, { \"month\": \"2016-02\", \"commits\": 33 }, { \"month\": \"2016-03\", \"commits\": 2 }, { \"month\": \"2016-04\", \"commits\": 9 }, { \"month\": \"2016-05\", \"commits\": 4 }, { \"month\": \"2016-06\", \"commits\": 34 }, { \"month\": \"2016-07\", \"commits\": 11 } ], \"language\": \"Kotlin\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 471 }, { \"month\": \"2012-02\", \"commits\": 376 }, { \"month\": \"2012-03\", \"commits\": 92 }, { \"month\": \"2015-01\", \"commits\": 843 }, { \"month\": \"2015-02\", \"commits\": 517 }, { \"month\": \"2015-03\", \"commits\": 53 }, { \"month\": \"2015-06\", \"commits\": 763 }, { \"month\": \"2015-07\", \"commits\": 355 }, { \"month\": \"2016-01\", \"commits\": 1167 }, { \"month\": \"2016-02\", \"commits\": 1672 }, { \"month\": \"2016-03\", \"commits\": 577 }, { \"month\": \"2016-04\", \"commits\": 217 }, { \"month\": \"2016-05\", \"commits\": 359 }, { \"month\": \"2016-06\", \"commits\": 391 }, { \"month\": \"2016-07\", \"commits\": 193 }, { \"month\": \"2016-10\", \"commits\": 507 } ], \"language\": \"Python\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 403 }, { \"month\": \"2012-02\", \"commits\": 375 }, { \"month\": \"2012-03\", \"commits\": 153 }, { \"month\": \"2015-01\", \"commits\": 1109 }, { \"month\": \"2015-02\", \"commits\": 727 }, { \"month\": \"2015-03\", \"commits\": 35 }, { \"month\": \"2015-06\", \"commits\": 809 }, { \"month\": \"2015-07\", \"commits\": 589 }, { \"month\": \"2016-01\", \"commits\": 603 }, { \"month\": \"2016-02\", \"commits\": 702 }, { \"month\": \"2016-03\", \"commits\": 427 }, { \"month\": \"2016-04\", \"commits\": 366 }, { \"month\": \"2016-05\", \"commits\": 426 }, { \"month\": \"2016-06\", \"commits\": 676 }, { \"month\": \"2016-07\", \"commits\": 271 }, { \"month\": \"2016-10\", \"commits\": 368 } ], \"language\": \"Java\" }, { \"trend\": [ { \"month\": \"2016-01\", \"commits\": 1 }, { \"month\": \"2016-05\", \"commits\": 31 } ], \"language\": \"Scheme\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-02\", \"commits\": 12 }, { \"month\": \"2012-03\", \"commits\": 1 }, { \"month\": \"2015-01\", \"commits\": 80 }, { \"month\": \"2015-02\", \"commits\": 98 }, { \"month\": \"2015-03\", \"commits\": 3 }, { \"month\": \"2015-06\", \"commits\": 65 }, { \"month\": \"2015-07\", \"commits\": 65 }, { \"month\": \"2016-01\", \"commits\": 22 }, { \"month\": \"2016-02\", \"commits\": 21 }, { \"month\": \"2016-03\", \"commits\": 23 }, { \"month\": \"2016-04\", \"commits\": 36 }, { \"month\": \"2016-05\", \"commits\": 48 }, { \"month\": \"2016-06\", \"commits\": 39 }, { \"month\": \"2016-07\", \"commits\": 2 }, { \"month\": \"2016-10\", \"commits\": 69 } ], \"language\": \"Emacs Lisp\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 2740 }, { \"month\": \"2015-02\", \"commits\": 2355 }, { \"month\": \"2015-03\", \"commits\": 14 }, { \"month\": \"2015-06\", \"commits\": 3455 }, { \"month\": \"2015-07\", \"commits\": 1733 }, { \"month\": \"2016-01\", \"commits\": 5606 }, { \"month\": \"2016-02\", \"commits\": 4467 }, { \"month\": \"2016-03\", \"commits\": 4008 }, { \"month\": \"2016-04\", \"commits\": 3832 }, { \"month\": \"2016-05\", \"commits\": 3441 }, { \"month\": \"2016-06\", \"commits\": 7763 }, { \"month\": \"2016-07\", \"commits\": 2267 }, { \"month\": \"2016-10\", \"commits\": 4016 } ], \"language\": \"Go\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 38 }, { \"month\": \"2012-02\", \"commits\": 20 }, { \"month\": \"2012-03\", \"commits\": 2 }, { \"month\": \"2015-01\", \"commits\": 71 }, { \"month\": \"2015-02\", \"commits\": 14 }, { \"month\": \"2015-03\", \"commits\": 2 }, { \"month\": \"2015-06\", \"commits\": 71 }, { \"month\": \"2015-07\", \"commits\": 30 }, { \"month\": \"2016-01\", \"commits\": 86 }, { \"month\": \"2016-02\", \"commits\": 12 }, { \"month\": \"2016-03\", \"commits\": 75 }, { \"month\": \"2016-04\", \"commits\": 54 }, { \"month\": \"2016-05\", \"commits\": 46 }, { \"month\": \"2016-06\", \"commits\": 16 }, { \"month\": \"2016-07\", \"commits\": 11 }, { \"month\": \"2016-10\", \"commits\": 4 } ], \"language\": \"Perl\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 64 }, { \"month\": \"2012-02\", \"commits\": 48 }, { \"month\": \"2012-03\", \"commits\": 42 }, { \"month\": \"2015-01\", \"commits\": 505 }, { \"month\": \"2015-02\", \"commits\": 279 }, { \"month\": \"2015-03\", \"commits\": 8 }, { \"month\": \"2015-06\", \"commits\": 513 }, { \"month\": \"2015-07\", \"commits\": 359 }, { \"month\": \"2016-01\", \"commits\": 517 }, { \"month\": \"2016-02\", \"commits\": 518 }, { \"month\": \"2016-03\", \"commits\": 390 }, { \"month\": \"2016-04\", \"commits\": 191 }, { \"month\": \"2016-05\", \"commits\": 334 }, { \"month\": \"2016-06\", \"commits\": 494 }, { \"month\": \"2016-07\", \"commits\": 111 }, { \"month\": \"2016-10\", \"commits\": 278 } ] }, { \"trend\": [ { \"month\": \"2015-07\", \"commits\": 16 } ], \"language\": \"Eagle\" }, { \"trend\": [ { \"month\": \"2016-10\", \"commits\": 1 } ], \"language\": \"GCC Machine Description\" }, { \"trend\": [ { \"month\": \"2016-05\", \"commits\": 2 } ], \"language\": \"AMPL\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 5 }, { \"month\": \"2015-03\", \"commits\": 1 }, { \"month\": \"2015-06\", \"commits\": 11 }, { \"month\": \"2015-07\", \"commits\": 1 }, { \"month\": \"2016-01\", \"commits\": 2 }, { \"month\": \"2016-02\", \"commits\": 4 }, { \"month\": \"2016-03\", \"commits\": 35 }, { \"month\": \"2016-04\", \"commits\": 11 }, { \"month\": \"2016-05\", \"commits\": 2 }, { \"month\": \"2016-06\", \"commits\": 26 }, { \"month\": \"2016-10\", \"commits\": 1 } ], \"language\": \"Makefile\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 355 }, { \"month\": \"2012-02\", \"commits\": 496 }, { \"month\": \"2012-03\", \"commits\": 185 }, { \"month\": \"2015-01\", \"commits\": 807 }, { \"month\": \"2015-02\", \"commits\": 1050 }, { \"month\": \"2015-03\", \"commits\": 81 }, { \"month\": \"2015-06\", \"commits\": 815 }, { \"month\": \"2015-07\", \"commits\": 421 }, { \"month\": \"2016-01\", \"commits\": 424 }, { \"month\": \"2016-02\", \"commits\": 320 }, { \"month\": \"2016-03\", \"commits\": 145 }, { \"month\": \"2016-04\", \"commits\": 156 }, { \"month\": \"2016-05\", \"commits\": 180 }, { \"month\": \"2016-06\", \"commits\": 164 }, { \"month\": \"2016-07\", \"commits\": 92 }, { \"month\": \"2016-10\", \"commits\": 164 } ], \"language\": \"Ruby\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 16 }, { \"month\": \"2016-02\", \"commits\": 2 } ], \"language\": \"Tcl\" }, { \"trend\": [ { \"month\": \"2012-02\", \"commits\": 2 }, { \"month\": \"2015-01\", \"commits\": 64 }, { \"month\": \"2015-02\", \"commits\": 36 }, { \"month\": \"2015-06\", \"commits\": 64 }, { \"month\": \"2015-07\", \"commits\": 4 }, { \"month\": \"2016-01\", \"commits\": 2 }, { \"month\": \"2016-02\", \"commits\": 17 }, { \"month\": \"2016-04\", \"commits\": 8 }, { \"month\": \"2016-05\", \"commits\": 3 }, { \"month\": \"2016-06\", \"commits\": 3 }, { \"month\": \"2016-07\", \"commits\": 1 } ], \"language\": \"TeX\" }, { \"trend\": [ { \"month\": \"2016-01\", \"commits\": 1049 }, { \"month\": \"2016-02\", \"commits\": 215 }, { \"month\": \"2016-03\", \"commits\": 10 }, { \"month\": \"2016-04\", \"commits\": 112 }, { \"month\": \"2016-05\", \"commits\": 130 }, { \"month\": \"2016-06\", \"commits\": 42 }, { \"month\": \"2016-07\", \"commits\": 18 }, { \"month\": \"2016-10\", \"commits\": 44 } ], \"language\": \"TypeScript\" }, { \"trend\": [ { \"month\": \"2016-02\", \"commits\": 2 } ], \"language\": \"DTrace\" }, { \"trend\": [ { \"month\": \"2015-06\", \"commits\": 1 }, { \"month\": \"2016-02\", \"commits\": 3 }, { \"month\": \"2016-06\", \"commits\": 21 } ], \"language\": \"Arduino\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 12 }, { \"month\": \"2012-02\", \"commits\": 1 }, { \"month\": \"2015-02\", \"commits\": 1 }, { \"month\": \"2015-06\", \"commits\": 1 }, { \"month\": \"2016-06\", \"commits\": 13 }, { \"month\": \"2016-07\", \"commits\": 3 }, { \"month\": \"2016-10\", \"commits\": 21 } ], \"language\": \"Haskell\" }, { \"trend\": [ { \"month\": \"2016-01\", \"commits\": 5 }, { \"month\": \"2016-02\", \"commits\": 5 }, { \"month\": \"2016-04\", \"commits\": 4 }, { \"month\": \"2016-05\", \"commits\": 6 }, { \"month\": \"2016-07\", \"commits\": 7 } ], \"language\": \"Jupyter Notebook\" }, { \"trend\": [ { \"month\": \"2012-03\", \"commits\": 1 }, { \"month\": \"2015-01\", \"commits\": 1 }, { \"month\": \"2015-02\", \"commits\": 73 }, { \"month\": \"2015-06\", \"commits\": 2 }, { \"month\": \"2016-01\", \"commits\": 29 }, { \"month\": \"2016-02\", \"commits\": 17 }, { \"month\": \"2016-03\", \"commits\": 16 }, { \"month\": \"2016-04\", \"commits\": 11 }, { \"month\": \"2016-06\", \"commits\": 22 }, { \"month\": \"2016-10\", \"commits\": 5 } ], \"language\": \"C#\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 1 }, { \"month\": \"2015-02\", \"commits\": 1 }, { \"month\": \"2015-07\", \"commits\": 1 } ], \"language\": \"Brainfuck\" }, { \"trend\": [ { \"month\": \"2015-06\", \"commits\": 1 }, { \"month\": \"2016-01\", \"commits\": 1 }, { \"month\": \"2016-02\", \"commits\": 3 } ], \"language\": \"CMake\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 3 }, { \"month\": \"2015-07\", \"commits\": 10 }, { \"month\": \"2016-01\", \"commits\": 22 }, { \"month\": \"2016-02\", \"commits\": 31 }, { \"month\": \"2016-03\", \"commits\": 23 }, { \"month\": \"2016-04\", \"commits\": 10 }, { \"month\": \"2016-05\", \"commits\": 2 }, { \"month\": \"2016-06\", \"commits\": 13 }, { \"month\": \"2016-07\", \"commits\": 5 }, { \"month\": \"2016-10\", \"commits\": 1 } ], \"language\": \"Elixir\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 12 }, { \"month\": \"2015-02\", \"commits\": 62 }, { \"month\": \"2015-06\", \"commits\": 25 }, { \"month\": \"2016-03\", \"commits\": 1 }, { \"month\": \"2016-05\", \"commits\": 7 }, { \"month\": \"2016-06\", \"commits\": 2 } ], \"language\": \"Clojure\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 11 }, { \"month\": \"2015-01\", \"commits\": 118 }, { \"month\": \"2015-02\", \"commits\": 176 }, { \"month\": \"2015-06\", \"commits\": 92 }, { \"month\": \"2015-07\", \"commits\": 49 }, { \"month\": \"2016-01\", \"commits\": 58 }, { \"month\": \"2016-02\", \"commits\": 34 }, { \"month\": \"2016-03\", \"commits\": 52 }, { \"month\": \"2016-04\", \"commits\": 21 }, { \"month\": \"2016-05\", \"commits\": 11 }, { \"month\": \"2016-06\", \"commits\": 13 }, { \"month\": \"2016-07\", \"commits\": 26 }, { \"month\": \"2016-10\", \"commits\": 68 } ], \"language\": \"CoffeeScript\" }, { \"trend\": [ { \"month\": \"2015-02\", \"commits\": 5 } ], \"language\": \"Racket\" }, { \"trend\": [ { \"month\": \"2015-06\", \"commits\": 34 }, { \"month\": \"2015-07\", \"commits\": 24 }, { \"month\": \"2016-06\", \"commits\": 6 }, { \"month\": \"2016-10\", \"commits\": 44 } ], \"language\": \"Elm\" }, { \"trend\": [ { \"month\": \"2012-01\", \"commits\": 67 }, { \"month\": \"2012-02\", \"commits\": 6 }, { \"month\": \"2015-01\", \"commits\": 19 }, { \"month\": \"2015-02\", \"commits\": 18 }, { \"month\": \"2015-03\", \"commits\": 4 }, { \"month\": \"2015-06\", \"commits\": 4 }, { \"month\": \"2016-01\", \"commits\": 40 }, { \"month\": \"2016-02\", \"commits\": 46 }, { \"month\": \"2016-03\", \"commits\": 14 }, { \"month\": \"2016-04\", \"commits\": 4 }, { \"month\": \"2016-05\", \"commits\": 2 }, { \"month\": \"2016-06\", \"commits\": 19 }, { \"month\": \"2016-07\", \"commits\": 7 } ], \"language\": \"Batchfile\" }, { \"trend\": [ { \"month\": \"2016-03\", \"commits\": 3 }, { \"month\": \"2016-05\", \"commits\": 2 }, { \"month\": \"2016-06\", \"commits\": 4 } ], \"language\": \"DIGITAL Command Language\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 3 }, { \"month\": \"2015-02\", \"commits\": 20 }, { \"month\": \"2015-06\", \"commits\": 44 }, { \"month\": \"2015-07\", \"commits\": 51 }, { \"month\": \"2016-01\", \"commits\": 8 }, { \"month\": \"2016-06\", \"commits\": 20 } ], \"language\": \"Objective-C++\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 39 }, { \"month\": \"2012-02\", \"commits\": 39 }, { \"month\": \"2012-03\", \"commits\": 34 }, { \"month\": \"2015-01\", \"commits\": 73 }, { \"month\": \"2015-02\", \"commits\": 89 }, { \"month\": \"2015-03\", \"commits\": 6 }, { \"month\": \"2015-06\", \"commits\": 130 }, { \"month\": \"2015-07\", \"commits\": 78 }, { \"month\": \"2016-01\", \"commits\": 80 }, { \"month\": \"2016-02\", \"commits\": 86 }, { \"month\": \"2016-03\", \"commits\": 96 }, { \"month\": \"2016-04\", \"commits\": 136 }, { \"month\": \"2016-05\", \"commits\": 85 }, { \"month\": \"2016-06\", \"commits\": 110 }, { \"month\": \"2016-07\", \"commits\": 26 }, { \"month\": \"2016-10\", \"commits\": 52 } ], \"language\": \"VimL\" }, { \"trend\": [ { \"month\": \"2016-04\", \"commits\": 108 } ], \"language\": \"PLpgSQL\" }, { \"trend\": [ { \"month\": \"2016-01\", \"commits\": 1 } ], \"language\": \"Smarty\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 7 }, { \"month\": \"2012-02\", \"commits\": 4 }, { \"month\": \"2015-01\", \"commits\": 22 }, { \"month\": \"2015-02\", \"commits\": 12 }, { \"month\": \"2015-07\", \"commits\": 1 }, { \"month\": \"2016-01\", \"commits\": 16 }, { \"month\": \"2016-02\", \"commits\": 4 }, { \"month\": \"2016-03\", \"commits\": 2 }, { \"month\": \"2016-06\", \"commits\": 17 }, { \"month\": \"2016-10\", \"commits\": 27 } ], \"language\": \"Erlang\" }, { \"trend\": [ { \"month\": \"2016-10\", \"commits\": 2 } ], \"language\": \"Nix\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 769 }, { \"month\": \"2012-02\", \"commits\": 718 }, { \"month\": \"2012-03\", \"commits\": 301 }, { \"month\": \"2015-01\", \"commits\": 1302 }, { \"month\": \"2015-02\", \"commits\": 2028 }, { \"month\": \"2015-03\", \"commits\": 59 }, { \"month\": \"2015-06\", \"commits\": 1139 }, { \"month\": \"2015-07\", \"commits\": 919 }, { \"month\": \"2016-01\", \"commits\": 1370 }, { \"month\": \"2016-02\", \"commits\": 839 }, { \"month\": \"2016-03\", \"commits\": 675 }, { \"month\": \"2016-04\", \"commits\": 730 }, { \"month\": \"2016-05\", \"commits\": 1516 }, { \"month\": \"2016-06\", \"commits\": 1159 }, { \"month\": \"2016-07\", \"commits\": 394 }, { \"month\": \"2016-10\", \"commits\": 1360 } ], \"language\": \"C\" }, { \"trend\": [ { \"month\": \"2016-02\", \"commits\": 10 }, { \"month\": \"2016-03\", \"commits\": 2 }, { \"month\": \"2016-07\", \"commits\": 2 } ], \"language\": \"Protocol Buffer\" }, { \"trend\": [ { \"month\": \"2015-06\", \"commits\": 42 }, { \"month\": \"2015-07\", \"commits\": 1 } ], \"language\": \"Nimrod\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 69 }, { \"month\": \"2012-02\", \"commits\": 96 }, { \"month\": \"2012-03\", \"commits\": 33 }, { \"month\": \"2015-01\", \"commits\": 1359 }, { \"month\": \"2015-02\", \"commits\": 1777 }, { \"month\": \"2015-03\", \"commits\": 39 }, { \"month\": \"2015-06\", \"commits\": 2182 }, { \"month\": \"2015-07\", \"commits\": 994 }, { \"month\": \"2016-01\", \"commits\": 2013 }, { \"month\": \"2016-02\", \"commits\": 1854 }, { \"month\": \"2016-03\", \"commits\": 2059 }, { \"month\": \"2016-04\", \"commits\": 1868 }, { \"month\": \"2016-05\", \"commits\": 1972 }, { \"month\": \"2016-06\", \"commits\": 3046 }, { \"month\": \"2016-07\", \"commits\": 890 }, { \"month\": \"2016-10\", \"commits\": 1605 } ], \"language\": \"HTML\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 4 }, { \"month\": \"2016-01\", \"commits\": 2 } ], \"language\": \"XSLT\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 13 }, { \"month\": \"2012-02\", \"commits\": 16 }, { \"month\": \"2012-03\", \"commits\": 12 }, { \"month\": \"2015-01\", \"commits\": 567 }, { \"month\": \"2015-02\", \"commits\": 253 }, { \"month\": \"2015-03\", \"commits\": 20 }, { \"month\": \"2015-06\", \"commits\": 456 }, { \"month\": \"2015-07\", \"commits\": 331 }, { \"month\": \"2016-01\", \"commits\": 310 }, { \"month\": \"2016-02\", \"commits\": 413 }, { \"month\": \"2016-03\", \"commits\": 177 }, { \"month\": \"2016-04\", \"commits\": 183 }, { \"month\": \"2016-05\", \"commits\": 673 }, { \"month\": \"2016-06\", \"commits\": 546 }, { \"month\": \"2016-07\", \"commits\": 40 }, { \"month\": \"2016-10\", \"commits\": 149 } ], \"language\": \"OCaml\" }, { \"trend\": [ { \"month\": \"2015-02\", \"commits\": 3 } ], \"language\": \"ApacheConf\" }, { \"trend\": [ { \"month\": \"2015-02\", \"commits\": 6 }, { \"month\": \"2015-06\", \"commits\": 30 }, { \"month\": \"2016-01\", \"commits\": 2 }, { \"month\": \"2016-02\", \"commits\": 62 }, { \"month\": \"2016-03\", \"commits\": 6 }, { \"month\": \"2016-04\", \"commits\": 5 }, { \"month\": \"2016-05\", \"commits\": 1 }, { \"month\": \"2016-06\", \"commits\": 3 } ], \"language\": \"PowerShell\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-02\", \"commits\": 3 }, { \"month\": \"2015-01\", \"commits\": 16 }, { \"month\": \"2015-02\", \"commits\": 17 }, { \"month\": \"2015-06\", \"commits\": 149 }, { \"month\": \"2015-07\", \"commits\": 29 }, { \"month\": \"2016-01\", \"commits\": 19 }, { \"month\": \"2016-02\", \"commits\": 25 }, { \"month\": \"2016-04\", \"commits\": 6 }, { \"month\": \"2016-05\", \"commits\": 21 }, { \"month\": \"2016-06\", \"commits\": 1 }, { \"month\": \"2016-07\", \"commits\": 2 }, { \"month\": \"2016-10\", \"commits\": 16 } ], \"language\": \"Lua\" }, { \"trend\": [ { \"month\": \"2015-01\", \"commits\": 10 }, { \"month\": \"2015-02\", \"commits\": 3 }, { \"month\": \"2016-06\", \"commits\": 3 } ], \"language\": \"Nginx\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 63 }, { \"month\": \"2012-02\", \"commits\": 120 }, { \"month\": \"2012-03\", \"commits\": 14 }, { \"month\": \"2015-01\", \"commits\": 315 }, { \"month\": \"2015-02\", \"commits\": 47 }, { \"month\": \"2015-06\", \"commits\": 328 }, { \"month\": \"2015-07\", \"commits\": 54 }, { \"month\": \"2016-01\", \"commits\": 501 }, { \"month\": \"2016-02\", \"commits\": 572 }, { \"month\": \"2016-03\", \"commits\": 386 }, { \"month\": \"2016-04\", \"commits\": 234 }, { \"month\": \"2016-05\", \"commits\": 176 }, { \"month\": \"2016-06\", \"commits\": 420 }, { \"month\": \"2016-07\", \"commits\": 93 }, { \"month\": \"2016-10\", \"commits\": 166 } ], \"language\": \"R\" }, { \"trend\": [ { \"month\": \"2015-02\", \"commits\": 6 }, { \"month\": \"2015-06\", \"commits\": 3 }, { \"month\": \"2016-01\", \"commits\": 201 }, { \"month\": \"2016-02\", \"commits\": 216 }, { \"month\": \"2016-03\", \"commits\": 130 }, { \"month\": \"2016-04\", \"commits\": 86 }, { \"month\": \"2016-05\", \"commits\": 105 }, { \"month\": \"2016-06\", \"commits\": 210 }, { \"month\": \"2016-07\", \"commits\": 24 }, { \"month\": \"2016-10\", \"commits\": 199 } ], \"language\": \"Groovy\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 1463 }, { \"month\": \"2012-02\", \"commits\": 1481 }, { \"month\": \"2012-03\", \"commits\": 459 }, { \"month\": \"2015-01\", \"commits\": 5015 }, { \"month\": \"2015-02\", \"commits\": 4122 }, { \"month\": \"2015-03\", \"commits\": 191 }, { \"month\": \"2015-06\", \"commits\": 3597 }, { \"month\": \"2015-07\", \"commits\": 1760 }, { \"month\": \"2016-01\", \"commits\": 3890 }, { \"month\": \"2016-02\", \"commits\": 3380 }, { \"month\": \"2016-03\", \"commits\": 2491 }, { \"month\": \"2016-04\", \"commits\": 2681 }, { \"month\": \"2016-05\", \"commits\": 2916 }, { \"month\": \"2016-06\", \"commits\": 3388 }, { \"month\": \"2016-07\", \"commits\": 963 }, { \"month\": \"2016-10\", \"commits\": 2066 } ], \"language\": \"JavaScript\" }, { \"trend\": [ { \"month\": \"2015-06\", \"commits\": 5 } ], \"language\": \"Gnuplot\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 11 }, { \"month\": \"2012-02\", \"commits\": 11 }, { \"month\": \"2015-01\", \"commits\": 98 }, { \"month\": \"2015-02\", \"commits\": 31 }, { \"month\": \"2015-06\", \"commits\": 206 }, { \"month\": \"2015-07\", \"commits\": 82 }, { \"month\": \"2016-01\", \"commits\": 375 }, { \"month\": \"2016-02\", \"commits\": 162 }, { \"month\": \"2016-03\", \"commits\": 61 }, { \"month\": \"2016-04\", \"commits\": 74 }, { \"month\": \"2016-05\", \"commits\": 92 }, { \"month\": \"2016-06\", \"commits\": 84 }, { \"month\": \"2016-07\", \"commits\": 19 }, { \"month\": \"2016-10\", \"commits\": 81 } ], \"language\": \"Objective-C\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 88 }, { \"month\": \"2012-02\", \"commits\": 156 }, { \"month\": \"2012-03\", \"commits\": 28 }, { \"month\": \"2015-01\", \"commits\": 4722 }, { \"month\": \"2015-02\", \"commits\": 4336 }, { \"month\": \"2015-03\", \"commits\": 231 }, { \"month\": \"2015-06\", \"commits\": 3633 }, { \"month\": \"2015-07\", \"commits\": 1861 }, { \"month\": \"2016-01\", \"commits\": 5407 }, { \"month\": \"2016-02\", \"commits\": 4540 }, { \"month\": \"2016-03\", \"commits\": 3098 }, { \"month\": \"2016-04\", \"commits\": 3086 }, { \"month\": \"2016-05\", \"commits\": 3400 }, { \"month\": \"2016-06\", \"commits\": 5037 }, { \"month\": \"2016-07\", \"commits\": 1602 }, { \"month\": \"2016-10\", \"commits\": 3229 } ], \"language\": \"Shell\" }, { \"trend\": [ { \"month\": \"2011-06\", \"commits\": 0 }, { \"month\": \"2012-01\", \"commits\": 165 }, { \"month\": \"2012-02\", \"commits\": 86 }, { \"month\": \"2012-03\", \"commits\": 26 }, { \"month\": \"2015-01\", \"commits\": 1183 }, { \"month\": \"2015-02\", \"commits\": 186 }, { \"month\": \"2015-06\", \"commits\": 71 }, { \"month\": \"2015-07\", \"commits\": 48 }, { \"month\": \"2016-01\", \"commits\": 294 }, { \"month\": \"2016-02\", \"commits\": 35 }, { \"month\": \"2016-03\", \"commits\": 73 }, { \"month\": \"2016-04\", \"commits\": 5 }, { \"month\": \"2016-05\", \"commits\": 92 }, { \"month\": \"2016-06\", \"commits\": 294 }, { \"month\": \"2016-07\", \"commits\": 28 }, { \"month\": \"2016-10\", \"commits\": 322 } ], \"language\": \"PHP\" } ]\t,\t\"status\": \"success\",\t\"metrics\": {\t\"elapsedTime\": \"93.075718719s\",\t\"executionTime\": \"93.074799808s\",\t\"resultCount\": \"60\", \"resultSize\": \"23239\"\t}}";
    }

    @ResponseBody
    @RequestMapping("/topPerformers")
    public String runCBASAnalyticsTopPerformers() throws Exception {
        String cbasQuery = "WITH userCommits AS ("
                + " SELECT d.developerInfo.username username, d.developerInfo.firstName||\" \"||d.developerInfo.lastName name,  d.developerInfo.email email, COUNT(*) commits "
                + " FROM events AS e, e.payload.shas AS commit, developers AS d "
                + " WHERE commit[3] = d.developerInfo.username "
                + " GROUP BY username, name, email "
                + " ) "
                + "   , "
                + " userOrganizations AS ( "
                + "     SELECT d.developerInfo.username username, org.websiteURL  "
                + "   FROM developers AS d, d.organizationIds AS oid, organizations AS org "
                + "     WHERE oid = org.id "
                + "  ) "
                + "  SELECT uo.url organization, "
                + "      ( "
                + "  SELECT uc.name, uc.email "
                + "  FROM uc "
                + "   ORDER BY uc.commits "
                + "   LIMIT 3 "
                + "  ) top_performers "
                + "   FROM userCommits uc "
                + "   JOIN userOrganizations uo ON uc.username = uo.username "
                + "   GROUP BY uo.url;";
//        return excuteCBASQuery(cbasQuery);

        return "{\t\"requestID\": \"15e66da9-c900-4cb7-9f39-04c6655d3b83\",\t\"signature\": \"*\",\t\"results\": [ { \"\ttop_performers\": [ { \"name\": \"Hideki Itakura\", \"email\": \"hideki@random.com\" }, { \"name\": \"Hideki Itakura\", \"email\": \"hideki@random.com\" }, { \"name\": \"Vanessa de Sant Anna\", \"email\": \"vanessa.santanna@gmail.com\" } ] } ]\t,\t\"status\": \"success\",\t\"metrics\": {\t\"elapsedTime\": \"7.215812821s\",\t\"executionTime\": \"7.214777704s\",\t\"resultCount\": \"1\",\t\"resultSize\": \"220\"\t}}";
    }

}
